<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ERCP - Pesquisa Instantânea</title>

<link rel="icon" type="image/png" href="https://raw.githubusercontent.com/estacaoremotadecampo/index/refs/heads/main/gwregister.png">
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
  .card-item { cursor: pointer; transition: transform 0.2s; }
  .card-item:hover { transform: scale(1.02); }
  .logo-header { max-height: 80px; margin-bottom: 20px; display: block; margin-left:auto; margin-right:auto; }
</style>
</head>
<body class="p-4">

<img src="https://raw.githubusercontent.com/estacaoremotadecampo/index/refs/heads/main/gwregister.png" alt="Logo" class="logo-header">

<h1 class="text-center mb-4">ERCP - Pesquisa Instantânea</h1>
<input id="searchInput" class="form-control mb-3" placeholder="Digite pelo menos 4 caracteres..." disabled>

<div id="cardsContainer" class="row">
  <div class="col-12 text-center" id="loadingMessage">Carregando dados...</div>
</div>

<!-- Modal -->
<div class="modal fade" id="infoModal" tabindex="-1" role="dialog" aria-labelledby="infoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="infoModalLabel">Detalhes da Malha</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <ul class="list-group" id="modalDetails"></ul>
      </div>
      <div class="modal-footer">
        <a id="downloadBtn" href="#" target="_blank" class="btn btn-primary">Download Desenho</a>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR9o4Q_wrHuNAlHUMmdrzGStmebFvVsSXI28Mta-lG74tMCzJY4Pvx3S8s3Hqhn1A/pub?gid=304106538&single=true&output=csv";
  const searchInput = document.getElementById('searchInput');
  const cardsContainer = document.getElementById('cardsContainer');
  const loadingMessage = document.getElementById('loadingMessage');
  const modalDetails = document.getElementById('modalDetails');
  const infoModalLabel = document.getElementById('infoModalLabel');
  const downloadBtn = document.getElementById('downloadBtn');
  let data = [];
  let debounceTimeout = null;
  const debounceDelay = 300;

  function createCard(item) {
    const col = document.createElement('div');
    col.className = 'col-md-4 mb-3';
    const card = document.createElement('div');
    card.className = 'card card-item p-2';
    card.innerHTML = `
      <h5 class="card-title"><strong>${item['Malha']}</strong></h5>
      <p class="card-text"><strong>Remota:</strong> ${item['Remota - ERCP']}<br>
      <strong>Localização:</strong> ${item['Localização']}</p>
    `;
    card.addEventListener('click', () => showModal(item));
    col.appendChild(card);
    return col;
  }

  function showModal(item) {
    infoModalLabel.textContent = `Malha: ${item['Malha']}`;
    modalDetails.innerHTML = '';
    ['Malha','Remota - ERCP','Localização','Rede','IBC','Cartão','Canal','Tipo do Cartão'].forEach(key=>{
      const li = document.createElement('li');
      li.className = 'list-group-item';
      li.innerHTML = `<strong>${key}:</strong> ${item[key] || '-'}`;
      modalDetails.appendChild(li);
    });

    const obsLink = item['Observação']?.trim();
    if(obsLink && obsLink.startsWith('http')){
      downloadBtn.href = obsLink;
      downloadBtn.style.display = 'inline-block';
    } else {
      downloadBtn.href = '#';
      downloadBtn.style.display = 'none';
    }

    $('#infoModal').modal('show');
  }

  function renderCards(arr) {
    cardsContainer.innerHTML = '';
    if(!arr.length) {
      cardsContainer.innerHTML = '<div class="col-12 text-center">Nenhum resultado encontrado.</div>';
      return;
    }
    arr.forEach(item => cardsContainer.appendChild(createCard(item)));
  }

  function filterData(q) {
    const lq = q.toLowerCase();
    return data.filter(item =>
      item['Malha'].toLowerCase().includes(lq) ||
      item['Remota - ERCP'].toLowerCase().includes(lq) ||
      (item['Localização']?.toLowerCase().includes(lq))
    );
  }

  function onSearch() {
    const q = searchInput.value.trim();
    if(q.length < 4){
      cardsContainer.innerHTML = '<div class="col-12 text-center">Digite pelo menos 4 caracteres para pesquisar.</div>';
      return;
    }
    renderCards(filterData(q));
  }

  try {
    const res = await fetch(sheetUrl);
    const csvText = await res.text();
    Papa.parse(csvText, {
      header: true,
      skipEmptyLines: true,
      complete: results => {
        data = results.data;
        loadingMessage.style.display = 'none';
        searchInput.disabled = false;
      },
      error: err => {
        cardsContainer.innerHTML = '<div class="col-12 text-center text-danger">Erro ao processar a planilha.</div>';
        console.error(err);
      }
    });
  } catch(e) {
    cardsContainer.innerHTML = '<div class="col-12 text-center text-danger">Erro ao carregar a planilha.</div>';
    console.error(e);
  }

  searchInput.addEventListener('input', () => {
    clearTimeout(debounceTimeout);
    debounceTimeout = setTimeout(onSearch, debounceDelay);
  });

});
</script>

</body>
</html>
