<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Suzano - Instrumenta√ß√£o & El√©trica</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    body { background:#f8f9fa; }
    .card-item { cursor:pointer; transition:transform .2s; }
    .card-item:hover { transform:scale(1.03); }
    #loadingOverlay {
      position: fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.6); display: none;
      justify-content: center; align-items: center; z-index: 2000;
    }
    #loadingOverlay span {
      color: #fff; font-size: 1.5rem; font-weight: bold;
      background: rgba(0,0,0,0.7); padding: 20px 40px;
      border-radius: 12px;
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav id="navbar" class="navbar navbar-expand-lg navbar-light bg-white shadow-sm px-3">
    <a class="navbar-brand" href="#">
      <img id="logo" src="https://enspace.io/wp-content/uploads/2024/12/Suzano-pixel-menor.png.webp" height="40">
    </a>
    <ul class="navbar-nav ms-auto">
      <li class="nav-item"><a id="linkInstrumentacao" href="#" class="nav-link">Instrumenta√ß√£o</a></li>
      <li class="nav-item"><a id="linkEletrica" href="#" class="nav-link">El√©trica</a></li>
    </ul>
  </nav>

  <!-- Loading Overlay -->
  <div id="loadingOverlay">
    <span>Carregando dados...</span>
  </div>

  <div class="container my-4">
    <div class="row mb-3">
      <div class="col-md-8">
        <input id="searchInput" class="form-control" type="text" placeholder="Pesquisar..." disabled>
      </div>
      <div class="col-md-4" id="filtroRapido" style="display:none;">
        <select id="filtroArea" class="form-select">
          <option value="">Filtrar por √Årea</option>
        </select>
      </div>
    </div>
    <div id="cardsContainer" class="row"></div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="infoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="infoModalLabel">Detalhes</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <ul id="modalDetails" class="list-group"></ul>
        </div>
        <div class="modal-footer">
          <a id="downloadBtn" href="#" class="btn btn-success" target="_blank" style="display:none;">Abrir Diagrama</a>
          <button class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('searchInput');
    const cardsContainer = document.getElementById('cardsContainer');
    const modalDetails = document.getElementById('modalDetails');
    const infoModalLabel = document.getElementById('infoModalLabel');
    const downloadBtn = document.getElementById('downloadBtn');
    const navbar = document.getElementById('navbar');
    const logo = document.getElementById('logo');
    const links = document.querySelectorAll('.nav-link');
    const filtroRapido = document.getElementById('filtroRapido');
    const filtroArea = document.getElementById('filtroArea');
    const loadingOverlay = document.getElementById('loadingOverlay');

    let dadosCache = {};
    let disciplinaAtual = "instrumentacao";

    const sheetUrls = {
      instrumentacao: "https://docs.google.com/spreadsheets/d/e/2PACX-1vR9o4Q_wrHuNAlHUMmdrzGStmebFvVsSXI28Mta-lG74tMCzJY4Pvx3S8s3Hqhn1A/pub?gid=304106538&single=true&output=csv",
      eletrica: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQB7VKBUBxLPr-cdvKE5TdIXxfTE0d-RsIT8RwoNWlEUHb-SeRTlOYMoHUVaK1veXp4vFZb58ONj0ah/pub?gid=0&single=true&output=csv"
    };

    function showLoading(){ loadingOverlay.style.display="flex"; }
    function hideLoading(){ loadingOverlay.style.display="none"; }

    function createCard(item, disciplina){
      const col = document.createElement('div');
      col.className='col-md-4 mb-3';
      const card=document.createElement('div');
      card.className='card card-item p-2';
      if(disciplina==="instrumentacao"){
        card.innerHTML=`
          <h5 class="card-title">${item['Malha']}</h5>
          <p><strong>Remota:</strong> ${item['Remota - ERCP']}<br>
          <strong>Localiza√ß√£o:</strong> ${item['Localiza√ß√£o']||'N√£o informada'}</p>`;
      } else {
        card.innerHTML=`
          <h5 class="card-title">${item['TAG DO ACIONAMENTO']}</h5>
          <p><strong>Painel:</strong> ${item['PAINEL']||''}</p>`;
      }
      card.addEventListener('click',()=>showModal(item,disciplina));
      col.appendChild(card);
      return col;
    }

    function showModal(item,disciplina){
      modalDetails.innerHTML="";
      if(disciplina==="instrumentacao"){
        infoModalLabel.textContent=`Malha: ${item['Malha']}`;
        const campos=['Malha','Remota - ERCP','Localiza√ß√£o','Rede','IBC','Cart√£o','Canal','Tipo do Cart√£o'];
        campos.forEach(c=>{
          const li=document.createElement('li');
          li.className='list-group-item';
          li.innerHTML=`<strong>${c}:</strong> ${item[c]||''}`;
          modalDetails.appendChild(li);
        });
        const obs=item['Observa√ß√£o']?.trim();
        if(obs && obs.startsWith("http")){
          downloadBtn.href=obs;
          downloadBtn.style.display="inline-block";
        } else downloadBtn.style.display="none";
      } else {
        infoModalLabel.textContent=`TAG: ${item['TAG DO ACIONAMENTO']}`;
        const campos=['TAG DO ACIONAMENTO','PAINEL','CCM/PI','GAVETA DO CCM','QD','GAVETA DO QD','N√öMERO','√ÅREA'];
        campos.forEach(c=>{
          const li=document.createElement('li');
          li.className='list-group-item';
          li.innerHTML=`<strong>${c}:</strong> ${item[c]||''}`;
          modalDetails.appendChild(li);
        });
        const obs=item['Observa√ß√£o']?.trim();
        if(obs && obs.startsWith("http")){
          downloadBtn.href=obs;
          downloadBtn.style.display="inline-block";
        } else downloadBtn.style.display="none";
      }
      new bootstrap.Modal(document.getElementById('infoModal')).show();
    }

    function renderCards(arr,disciplina){
      cardsContainer.innerHTML="";
      if(!arr.length){
        cardsContainer.innerHTML='<div class="col-12 text-center">Nenhum resultado encontrado.</div>';
        return;
      }
      arr.forEach(i=>cardsContainer.appendChild(createCard(i,disciplina)));
    }

    function filterData(q,disciplina){
      q=q.toLowerCase();
      let base=dadosCache[disciplina];
      if(disciplina==="eletrica"){
        const area=filtroArea.value;
        if(area) base=base.filter(i=>i['√ÅREA']===area);
      }
      return base.filter(i=>{
        if(disciplina==="instrumentacao")
          return i['Malha'].toLowerCase().includes(q) || i['Remota - ERCP'].toLowerCase().includes(q) || (i['Localiza√ß√£o']||'').toLowerCase().includes(q);
        else
          return i['TAG DO ACIONAMENTO'].toLowerCase().includes(q) || (i['PAINEL']||'').toLowerCase().includes(q);
      });
    }

    function onSearch(){
      const q=searchInput.value.trim();
      if(q.length<3){
        cardsContainer.innerHTML='<div class="col-12 text-center">Digite pelo menos 3 caracteres.</div>';
        return;
      }
      renderCards(filterData(q,disciplinaAtual),disciplinaAtual);
    }

    function renderFiltrosEletrica(data){
      const areas=[...new Set(data.map(i=>i['√ÅREA']).filter(Boolean))];
      filtroArea.innerHTML='<option value="">Filtrar por √Årea</option>';
      areas.forEach(a=>{
        const opt=document.createElement('option');
        opt.value=a; opt.textContent=a;
        filtroArea.appendChild(opt);
      });
      filtroRapido.style.display="block";
    }

    async function loadData(disciplina){
      if(dadosCache[disciplina]){
        if(disciplina==="eletrica") renderFiltrosEletrica(dadosCache[disciplina]);
        else filtroRapido.style.display="none";
        onSearch();
        return;
      }

      showLoading();
      searchInput.disabled=true;

      // üîπ Corre√ß√£o: estilo volta corretamente ao trocar disciplina
      if(disciplina==='instrumentacao'){
        navbar.style.backgroundColor='#fff';
        navbar.classList.remove('navbar-dark');
        navbar.classList.add('navbar-light');
        logo.src="https://enspace.io/wp-content/uploads/2024/12/Suzano-pixel-menor.png.webp";
        links.forEach(l=>l.style.color='#009739');
        filtroRapido.style.display="none";
      } else {
        navbar.style.backgroundColor='#003057';
        navbar.classList.remove('navbar-light');
        navbar.classList.add('navbar-dark');
        logo.src="https://cdn.prod.website-files.com/6671dffa07a8cb14145637d4/668fe0daade92a516783a75e_suzano_logo.png";
        links.forEach(l=>l.style.color='#fff');
      }

      try{
        const res=await fetch(sheetUrls[disciplina]);
        if(!res.ok) throw new Error("Erro HTTP "+res.status);
        const text=await res.text();
        dadosCache[disciplina]=Papa.parse(text,{header:true,skipEmptyLines:true}).data;
        hideLoading();
        searchInput.disabled=false;
        if(disciplina==="eletrica") renderFiltrosEletrica(dadosCache[disciplina]);
        else filtroRapido.style.display="none";
        onSearch();
      }catch(err){
        hideLoading();
        cardsContainer.innerHTML='<div class="col-12 text-center text-danger">Erro ao carregar dados.</div>';
        console.error(err);
      }
    }

    searchInput.addEventListener('input',()=>{ if(searchInput.value.length>=3) onSearch(); });
    filtroArea.addEventListener('change',onSearch);
    document.getElementById('linkInstrumentacao').addEventListener('click',()=>{disciplinaAtual="instrumentacao";loadData(disciplinaAtual);});
    document.getElementById('linkEletrica').addEventListener('click',()=>{disciplinaAtual="eletrica";loadData(disciplinaAtual);});

    loadData(disciplinaAtual); // inicia em instrumenta√ß√£o
  });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
