<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Instrumentação & Elétrica</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { background:#f8f9fa; }
    .card-item { cursor:pointer; transition:transform .2s; }
    .card-item:hover { transform:scale(1.03); }
    /* Popup de loading */
    #loadingPopup {
      display:none; position:fixed; top:0; left:0; right:0; bottom:0;
      background:rgba(0,0,0,0.6); z-index:2000;
      display:flex; align-items:center; justify-content:center;
    }
    #loadingPopup .content {
      background:#222; color:#fff; padding:20px 40px;
      border-radius:10px; text-align:center;
      box-shadow:0 0 20px rgba(0,0,0,0.8);
    }
    .tag-filtro {
      display:inline-block; margin:5px; padding:8px 15px; border-radius:20px;
      background:#f1f1f1; cursor:pointer; transition:.2s;
    }
    .tag-filtro.selected { background:#0d6efd; color:#fff; }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">
      <img id="logoNav" src="https://cdn.prod.website-files.com/6671dffa07a8cb14145637d4/668fe0daade92a516783a75e_suzano_logo.png" height="40">
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav me-auto">
        <li class="nav-item"><a class="nav-link active disciplina-link" href="#" data-disciplina="instrumentacao">Instrumentação</a></li>
        <li class="nav-item"><a class="nav-link disciplina-link" href="#" data-disciplina="eletrica">Elétrica</a></li>
      </ul>
      <div class="d-flex">
        <input id="searchInput" class="form-control me-2" type="search" placeholder="Pesquisar..." disabled>
        <button id="btnFiltro" class="btn btn-outline-light" style="display:none;">Filtros</button>
      </div>
    </div>
  </div>
</nav>

<div class="container mt-4">
  <div class="row" id="cardsContainer"></div>
</div>

<!-- Modal Detalhes -->
<div class="modal fade" id="infoModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="infoModalLabel">Detalhes</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body"><ul class="list-group" id="modalDetails"></ul></div>
      <div class="modal-footer">
        <a id="downloadBtn" class="btn btn-primary" href="#" target="_blank" style="display:none;">Baixar Diagrama</a>
        <button class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Filtros Elétrica -->
<div class="modal fade" id="filtroModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Filtrar por Área</h5></div>
      <div class="modal-body" id="filtroTagsContainer">
        <span class="tag-filtro" data-value="Caldeira de Recuperação">Caldeira de Recuperação</span>
        <span class="tag-filtro" data-value="ETAC">ETAC</span>
        <span class="tag-filtro" data-value="Central elétrica">Central elétrica</span>
        <span class="tag-filtro" data-value="ETA">ETA</span>
        <span class="tag-filtro" data-value="ETE">ETE</span>
        <span class="tag-filtro" data-value="CAE">CAE</span>
      </div>
      <div class="modal-footer">
        <button id="aplicarFiltro" class="btn btn-primary">Aplicar</button>
      </div>
    </div>
  </div>
</div>

<!-- Popup de Loading -->
<div id="loadingPopup"><div class="content"><div class="spinner-border text-light mb-2"></div><div id="loadingText">Carregando dados...</div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", async ()=>{
  const searchInput=document.getElementById("searchInput");
  const cardsContainer=document.getElementById("cardsContainer");
  const modalDetails=document.getElementById("modalDetails");
  const infoModalLabel=document.getElementById("infoModalLabel");
  const downloadBtn=document.getElementById("downloadBtn");
  const btnFiltro=document.getElementById("btnFiltro");
  const filtroTagsContainer=document.getElementById("filtroTagsContainer");
  const loadingPopup=document.getElementById("loadingPopup");
  const loadingText=document.getElementById("loadingText");

  let dataCache={}, disciplinaAtual="instrumentacao", filtrosSelecionados=[];
  let debounceTimeout=null;

  const urls={
    instrumentacao:"https://docs.google.com/spreadsheets/d/e/2PACX-1vR9o4Q_wrHuNAlHUMmdrzGStmebFvVsSXI28Mta-lG74tMCzJY4Pvx3S8s3Hqhn1A/pub?gid=304106538&single=true&output=csv",
    eletrica:"https://docs.google.com/spreadsheets/d/e/2PACX-1vQB7VKBUBxLPr-cdvKE5TdIXxfTE0d-RsIT8RwoNWlEUHb-SeRTlOYMoHUVaK1veXp4vFZb58ONj0ah/pub?gid=0&single=true&output=csv"
  };

  function showLoading(){loadingPopup.style.display="flex";}
  function hideLoading(){loadingPopup.style.display="none";}

  function createCard(item,disciplina){
    const col=document.createElement("div"); col.className="col-md-4 mb-3";
    const card=document.createElement("div"); card.className="card card-item p-2";
    if(disciplina==="instrumentacao"){
      card.innerHTML=`<h5>${item['Malha']}</h5><p><strong>Remota:</strong> ${item['Remota - ERCP']||''}<br><strong>Localização:</strong> ${item['Localização']||''}</p>`;
    }else{
      card.innerHTML=`<h5>${item['TAG DO ACIONAMENTO']||''}</h5><p><strong>Painel:</strong> ${item['PAINEL']||''}</p>`;
    }
    card.addEventListener("click",()=>showModal(item,disciplina));
    col.appendChild(card); return col;
  }

  function showModal(item,disciplina){
    modalDetails.innerHTML=""; downloadBtn.style.display="none";
    if(disciplina==="instrumentacao"){
      infoModalLabel.textContent=`Malha: ${item['Malha']}`;
      ['Malha','Remota - ERCP','Localização','Rede','IBC','Cartão','Canal','Tipo do Cartão'].forEach(k=>{
        const li=document.createElement("li"); li.className="list-group-item"; li.innerHTML=`<strong>${k}:</strong> ${item[k]||''}`; modalDetails.appendChild(li);
      });
      if(item['Observação']?.startsWith("http")){downloadBtn.href=item['Observação'];downloadBtn.style.display="inline-block";}
    }else{
      infoModalLabel.textContent=`TAG: ${item['TAG DO ACIONAMENTO']}`;
      ['TAG DO ACIONAMENTO','PAINEL','CCM/PI','GAVETA DO CCM','QD','GAVETA DO QD','NÚMERO','ÁREA'].forEach(k=>{
        const li=document.createElement("li"); li.className="list-group-item"; li.innerHTML=`<strong>${k}:</strong> ${item[k]||''}`; modalDetails.appendChild(li);
      });
      if(item['Observação']?.startsWith("http")){downloadBtn.href=item['Observação'];downloadBtn.style.display="inline-block";}
    }
    new bootstrap.Modal(document.getElementById('infoModal')).show();
  }

  function renderCards(arr,disciplina){
    cardsContainer.innerHTML=""; if(!arr.length){cardsContainer.innerHTML='<div class="col-12 text-center">Nenhum resultado.</div>';return;}
    arr.forEach(it=>cardsContainer.appendChild(createCard(it,disciplina)));
  }

  function filterData(q,disciplina){
    q=q.toLowerCase();
    return dataCache[disciplina].filter(item=>{
      if(disciplina==="instrumentacao"){
        return item['Malha']?.toLowerCase().includes(q)||item['Remota - ERCP']?.toLowerCase().includes(q)||item['Localização']?.toLowerCase().includes(q);
      }else{
        let ok=item['TAG DO ACIONAMENTO']?.toLowerCase().includes(q)||item['PAINEL']?.toLowerCase().includes(q);
        if(filtrosSelecionados.length){ok=ok&&filtrosSelecionados.includes(item['ÁREA']);}
        return ok;
      }
    });
  }

  function onSearch(){const q=searchInput.value.trim(); if(q.length<3){cardsContainer.innerHTML='<div class="col-12 text-center">Digite pelo menos 3 caracteres.</div>';return;} renderCards(filterData(q,disciplinaAtual),disciplinaAtual);}

  async function loadData(disciplina){
    const cacheKey="cache_"+disciplina, today=new Date().toISOString().split("T")[0];
    const saved=localStorage.getItem(cacheKey);
    if(saved){const {date,data}=JSON.parse(saved); if(date===today){dataCache[disciplina]=data; searchInput.disabled=false; btnFiltro.style.display=(disciplina==='eletrica')?'inline-block':'none'; return;}}
    showLoading();
    try{
      const res=await fetch("https://api.allorigins.win/raw?url="+encodeURIComponent(urls[disciplina])); const txt=await res.text();
      const parsed=Papa.parse(txt,{header:true,skipEmptyLines:true}); dataCache[disciplina]=parsed.data;
      localStorage.setItem(cacheKey,JSON.stringify({date:today,data:parsed.data}));
      searchInput.disabled=false; btnFiltro.style.display=(disciplina==='eletrica')?'inline-block':'none';
    }catch(e){cardsContainer.innerHTML='<div class="col-12 text-danger text-center">Erro ao carregar dados.</div>'; console.error(e);}
    hideLoading();
  }

  searchInput.addEventListener("input",()=>{clearTimeout(debounceTimeout); debounceTimeout=setTimeout(onSearch,300);});

  document.querySelectorAll(".disciplina-link").forEach(link=>{
    link.addEventListener("click",async e=>{
      e.preventDefault(); disciplinaAtual=e.target.dataset.disciplina; filtrosSelecionados=[];
      document.querySelectorAll(".disciplina-link").forEach(l=>l.classList.remove("active")); e.target.classList.add("active");
      await loadData(disciplinaAtual);
    });
  });

  btnFiltro.addEventListener("click",()=>new bootstrap.Modal(document.getElementById('filtroModal')).show());
  filtroTagsContainer.querySelectorAll(".tag-filtro").forEach(tag=>tag.addEventListener("click",()=>tag.classList.toggle("selected")));
  document.getElementById("aplicarFiltro").addEventListener("click",()=>{filtrosSelecionados=Array.from(filtroTagsContainer.querySelectorAll(".tag-filtro.selected")).map(t=>t.dataset.value); onSearch(); bootstrap.Modal.getInstance(document.getElementById('filtroModal')).hide();});

  await loadData(disciplinaAtual);
});
</script>
</body>
</html>
